<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" type="text/css" href="../css/index/header.css" />
    <link rel="stylesheet" type="text/css" href="../css/index/navigator.css" />
    <link rel="stylesheet" type="text/css" href="../css/index/footer.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="../css/ticketing/ticketing.css"
    />

    <title>Pererva</title>
  </head>
  <body>
    <header>
      <div id="logo">
        <a href="main.html">Pererva</a>
      </div>
      <div id="logAndSign">
        <a href="login.html">로그인</a>
        <a href="signin.html">회원가입</a>
      </div>
    </header>
    <div id="navigator">
      <div>
        <a href="ticketing.html">예매</a>
        <a href="movie_script/movie_1917_script.html">영화</a>
        <a href="Introduction.html">극장</a>
      </div>
    </div>
    <div id="selectMovie">
      <div id="movie">
        <div id="movieShow">
          <div class="movies">
            <label for="nineteen_seventeen">
              <img src="../image/nineteen_seventeen.jpg" />
            </label>
          </div>
          <div class="movies">
            <label for="joker"><img src="../image/joker.jpg" /></label>
          </div>
          <div class="movies">
            <label for="lady_bird">
              <img src="../image/lady_bird.jpg" />
            </label>
          </div>
        </div>
      </div>

      <div id="ticketForm">
        <div class="theater">
          <div class="theater-screen">스크린</div>
          <table id="theater-seats">
            <tr>
              <td class="seats">
                <label for="seat1"><p name="seatBox">1</p> </label>
                <input type="checkbox" name="seats" id="seat1" value="1" />
              </td>
              <td></td>
              <td class="seats">
                <label for="seat2"><p name="seatBox">2</p> </label>
                <input type="checkbox" name="seats" id="seat2" value="2" />
              </td>
              <td></td>
            </tr>
            <tr>
              <td></td>
              <td class="seats">
                <label for="seat3"><p name="seatBox">3</p> </label>
                <input type="checkbox" name="seats" id="seat3" value="3" />
              </td>
              <td></td>
              <td class="seats">
                <label for="seat4"><p name="seatBox">4</p> </label>
                <input type="checkbox" name="seats" id="seat4" value="4" />
              </td>
            </tr>
            <tr>
              <td class="seats">
                <label for="seat5"><p name="seatBox">5</p> </label>
                <input type="checkbox" name="seats" id="seat5" value="5" />
              </td>
              <td></td>
              <td class="seats">
                <label for="seat6"><p name="seatBox">6</p> </label>
                <input type="checkbox" name="seats" id="seat6" value="6" />
              </td>
              <td></td>
            </tr>
            <tr>
              <td></td>
              <td class="seats">
                <label for="seat7"><p name="seatBox">7</p> </label>
                <input type="checkbox" name="seats" id="seat7" value="7" />
              </td>
              <td></td>
              <td class="seats">
                <label for="seat8"><p name="seatBox">8</p> </label>
                <input type="checkbox" name="seats" id="seat8" value="8" />
              </td>
            </tr>
            <tr>
              <td class="seats">
                <label for="seat9"><p name="seatBox">9</p> </label>
                <input type="checkbox" name="seats" id="seat9" value="9" />
              </td>
              <td></td>
              <td class="seats">
                <label for="seat10"><p name="seatBox">10</p> </label>
                <input type="checkbox" name="seats" id="seat10" value="10" />
              </td>
              <td></td>
            </tr>
            <tr>
              <td></td>
              <td class="seats">
                <label for="seat11"><p name="seatBox">11</p> </label>
                <input type="checkbox" name="seats" id="seat11" value="11" />
              </td>
              <td></td>
              <td class="seats">
                <label for="seat12"><p name="seatBox">12</p> </label>
                <input type="checkbox" name="seats" id="seat12" value="12" />
              </td>
            </tr>
            <tr>
              <td class="seats">
                <label for="seat13"><p name="seatBox">13</p> </label>
                <input type="checkbox" name="seats" id="seat13" value="13" />
              </td>
              <td></td>
              <td class="seats">
                <label for="seat14"><p name="seatBox">14</p> </label>
                <input type="checkbox" name="seats" id="seat14" value="14" />
              </td>
              <td></td>
            </tr>
            <tr>
              <td></td>
              <td class="seats">
                <label for="seat15"><p name="seatBox">15</p> </label>
                <input type="checkbox" name="seats" id="seat15" value="15" />
              </td>
              <td></td>
              <td class="seats">
                <label for="seat16"><p name="seatBox">16</p> </label>
                <input type="checkbox" name="seats" id="seat16" value="16" />
              </td>
            </tr>
          </table>
        </div>
        <div id="selectForm">
          <fieldset>
            <legend>영화 선택</legend>
            <label for="nineteen_seventeen">1917</label>
            <input
              type="radio"
              name="selectMovie"
              id="nineteen_seventeen"
              value="nineteen_seventeen"
            />
            <label for="joker">JOKER</label>
            <input type="radio" name="selectMovie" id="joker" value="joker" />
            <label for="lady_bird">Lady Bird</label>
            <input
              type="radio"
              name="selectMovie"
              id="lady_bird"
              value="lady_bird"
            />
          </fieldset>
          <fieldset id="ticketDate">
            <legend>날짜</legend>
            <input type="date" id="date" />
          </fieldset>
          <fieldset id="ticketTime">
            <legend>상영 시간</legend>
            <label for="morning">08:00 ~ 10:30</label>
            <input
              type="radio"
              name="ticketTime"
              id="morning"
              value="08:00~10:30"
            /><br />
            <label for="first">10:45 ~ 13:15</label>
            <input
              type="radio"
              name="ticketTime"
              id="first"
              value="10:45~13:15"
            /><br />
            <label for="second">13:30 ~ 16:00</label>
            <input
              type="radio"
              name="ticketTime"
              id="second"
              value="13:30~16:00"
            /><br />
            <label for="third">16:15 ~ 18:45</label>
            <input
              type="radio"
              name="ticketTime"
              id="third"
              value="16:15~18:45"
            /><br />
            <label for="fourth">19:00 ~ 21:30</label>
            <input
              type="radio"
              name="ticketTime"
              id="fourth"
              value="19:00~21:00"
            /><br />
            <label for="fifth">21:45 ~ 24:15</label>
            <input
              type="radio"
              name="ticketTime"
              id="fifth"
              value="21:45~24:15"
            /><br />
            <label for="sixth">24:30 ~ 3:00</label>
            <input
              type="radio"
              name="ticketTime"
              id="sixth"
              value="24:30~3:00"
            />
          </fieldset>
          <div class="notice">
            Notice
            <p>
              첫번째 영화는 20% 조조할인입니다. <br />
              군인/의경/사회복무요원 할인은 <br />
              현장 예매입니다.
            </p>
          </div>
          <fieldset>
            <legend>인원</legend>
            <label for="adult">일반</label>
            <select name="adult" id="adult" size="1">
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
            <label for="student">청소년</label>
            <select name="student" id="student" size="1"
              ><option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
            <label for="preferential">우대</label>
            <select name="preferential" id="preferential" size="1">
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </fieldset>
          <div id="charge">
            0
          </div>
          <button type="button" onclick="ticketingMovie()">예매하기</button>
          <button type="button" onclick="location.href='showTicketing.html'">
            예매확인
          </button>
        </div>
      </div>
    </div>
    <footer>
      <div>
        위치: 인천광역시 남동구 만수동 50번길 56
      </div>
      <div>
        대표: 상진수
      </div>
      <div>
        전화번호: 032-0000-0000
      </div>
      <div>
        사업자등록번호 333-99-00999
      </div>
    </footer>
  </body>
  <script type="text/javascript">
    function ticketingMovie() {
      let movieName = "";
      let movieDate = "";
      let movieTime = "";
      let adult = 0;
      let student = 0;
      let preferential = 0;
      let movieSeats = [];

      const selectMovies = document.getElementsByName("selectMovie");
      const selectSeats = document.getElementsByName("seats");
      const selectDate = document.getElementById("date");
      const selectTime = document.getElementsByName("ticketTime");
      const numAdult = document.getElementById("adult");
      const numStudent = document.getElementById("student");
      const numPreferential = document.getElementById("preferential");

      for (let i = 0; i < selectMovies.length; i++) {
        if (selectMovies[i].checked) {
          switch (selectMovies[i].value) {
            case "nineteen_seventeen":
              movieName = "1917";
              break;
            case "joker":
              movieName = "JOKER";
              break;
            case "lady_bird":
              movieName = "레이디 버드";
            default:
              break;
          }
        }
      }

      for (let i = 0; i < selectSeats.length; i++) {
        if (selectSeats[i].checked) {
          movieSeats = movieSeats.concat(selectSeats[i].value);
        }
      }

      for (let i = 0; i < selectTime.length; i++) {
        if (selectTime[i].checked) {
          movieTime = selectTime[i].value;
        }
      }
      movieDate = selectDate.value;
      adult = parseInt(numAdult.options[numAdult.selectedIndex].value);
      student = parseInt(numStudent.options[numStudent.selectedIndex].value);
      preferential = parseInt(
        numPreferential.options[numPreferential.selectedIndex].value
      );
      if (movieName === "") {
        return alert("영화를 선택하세요!");
      }
      if (movieSeats.length == 0) {
        return alert("좌석을 선택하세요!");
      }
      if (movieTime === "") {
        return alert("상영 시간을 선택하세요!");
      }
      if (adult + student + preferential > 4) {
        return alert("최대 4명 예매가 가능합니다!");
      }
      if (movieSeats.length < adult + student + preferential) {
        return alert("좌석 수가 예매 인원보다 적습니다!");
      }
      if (movieSeats.length > adult + student + preferential) {
        return alert("예매 인원이 좌석 수보다 적습니다!");
      }

      const localStorage = window.localStorage;

      if (!localStorage) {
        return alert("로컬스토리지를 지원하지 않습니다!");
      }

      let ticketingList = JSON.parse(localStorage.getItem("ticketingList"));
      if (ticketingList.length == 10) {
        return alert("최대 예매 개수는 10개입니다. ");
      }
      for (let i = 0; i < ticketingList.length; i++) {
        const {
          movieName: reservedName,
          movieDate: reservedDate,
          movieSeats: reservedSeats,
          movieTime: reservedTime,
          ...rest
        } = ticketingList[i];
        if (
          movieName === reservedName &&
          movieDate === reservedDate &&
          movieTime === reservedTime
        ) {
          for (let j = 0; j < reservedSeats.length; j++) {
            if (movieSeats.includes(reservedSeats[j])) {
              return alert("이미 예약된 좌석입니다.");
            }
          }
        }
      }
      let payment =
        parseInt(adult) * 15000 +
        parseInt(student) * 10000 +
        parseInt(preferential) * 7500;
      if (document.getElementsByName("ticketTime")[0].checked) {
        payment *= 0.8;
      }
      let confirmResult = confirm(
        `${movieName}
        ${movieDate}, ${movieTime},
        ${movieSeats.length}석 일반: ${adult}명, 학생: ${student}명, 우대: ${preferential}
        금액: ${payment}원을 예매하시겠습니까?`
      );
      if (confirmResult) {
        let ticketingInfo = {
          movieName,
          movieDate,
          movieSeats,
          movieTime,
          adult,
          student,
          preferential,
          payment,
        };
        ticketingList = ticketingList.concat(ticketingInfo);
        localStorage.setItem("ticketingList", JSON.stringify(ticketingList));
      } else {
        return alert("예매 진행이 취소되었습니다.");
      }
    }

    function payChange() {
      const numAdult = document.getElementById("adult");
      const numStudent = document.getElementById("student");
      const numPreferential = document.getElementById("preferential");
      adult = numAdult.options[numAdult.selectedIndex].value;
      student = numStudent.options[numStudent.selectedIndex].value;
      preferential =
        numPreferential.options[numPreferential.selectedIndex].value;
      let payment = document.getElementById("charge");
      let total =
        parseInt(adult) * 15000 +
        parseInt(student) * 10000 +
        parseInt(preferential) * 7500;
      if (document.getElementsByName("ticketTime")[0].checked) {
        total *= 0.8;
      }
      payment.innerText = total;
    }

    function clickSeat() {
      const seatBoxes = document.getElementsByName("seatBox");
      let num = parseInt(this.value) - 1;
      if (this.checked) {
        seatBoxes[num].style.backgroundColor = "rgba(53, 59, 72,1.0)";
      } else {
        seatBoxes[num].style.backgroundColor = "rgba(113, 128, 147, 1)";
      }
    }

    const localStorage = window.localStorage;

    if (!localStorage) {
      alert("로컬스토리지를 지원하지 않습니다!");
    }
    if (localStorage.getItem("ticketingList") === null) {
      localStorage.setItem("ticketingList", JSON.stringify([]));
    }

    const tdate = document.getElementById("date");
    let current = new Date();
    let date = current.getDate();
    let month = current.getMonth() + 1;
    let year = current.getFullYear();
    if (date < 10) {
      date = "0" + date;
    }
    if (month < 10) {
      month = "0" + month;
    }

    current = year + "-" + month + "-" + date;
    exp = "2020" + "-" + "07" + "-" + "30";
    tdate.value = current;
    tdate.min = current;
    tdate.max = exp;

    const numAdult = document.getElementById("adult");
    const numStudent = document.getElementById("student");
    const numPreferential = document.getElementById("preferential");
    const selectTime = document.getElementsByName("ticketTime");

    numAdult.onclick = payChange;
    numStudent.onclick = payChange;
    numPreferential.onclick = payChange;
    selectTime.forEach((time) => (time.onclick = payChange));

    const selectSeats = document.getElementsByName("seats");
    selectSeats.forEach((seat) => (seat.onchange = clickSeat));
  </script>
</html>
